trigger:
  branches:
    include:
      - main

pool:
  name: MiPool   # O usa 'vmImage: "ubuntu-latest"' si prefer√≠s agente hospedado

variables:
  azureSubscription: 'tp05-connection'   # ‚öôÔ∏è nombre de tu Service Connection
  webAppFrontendQA: 'webapp-QA-2025'     # ‚öôÔ∏è nombre exacto de tu Web App Frontend QA
  webAppBackendQA: 'BACKEND-QA-2025'     # ‚öôÔ∏è nombre exacto de tu Web App Backend QA

stages:
  # ===========================
  # STAGE 1: BUILD (CI)
  # ===========================
  - stage: CI
    displayName: "Build & Test CI"
    jobs:

      # ---------- FRONTEND ----------
      - job: BuildFront
        displayName: "Build Frontend (React)"
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
            displayName: "Set Node.js version"

          - script: |
              cd frontend
              npm ci
              npm run build

              # üîß Crear archivo web.config para servir correctamente la SPA
              echo '<?xml version="1.0" encoding="utf-8"?>
              <configuration>
                <system.webServer>
                  <rewrite>
                    <rules>
                      <rule name="ReactRoutes" stopProcessing="true">
                        <match url=".*" />
                        <conditions logicalGrouping="MatchAll">
                          <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                          <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                        </conditions>
                        <action type="Rewrite" url="/index.html" />
                      </rule>
                    </rules>
                  </rewrite>
                  <staticContent>
                    <mimeMap fileExtension=".json" mimeType="application/json" />
                    <mimeMap fileExtension=".js" mimeType="application/javascript" />
                    <mimeMap fileExtension=".css" mimeType="text/css" />
                  </staticContent>
                </system.webServer>
              </configuration>' > build/web.config
            displayName: "Install, Build & Add web.config for Azure SPA"

          - task: ArchiveFiles@2
            displayName: "Zip frontend build"
            inputs:
              rootFolderOrFile: 'frontend/build'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
              replaceExistingArchive: true

          - publish: $(Build.ArtifactStagingDirectory)/frontend.zip
            artifact: drop_front
            displayName: "Publish Frontend Artifact"

      # ---------- BACKEND ----------
      - job: BuildBack
        displayName: "Build Backend (Go)"
        steps:
          - task: GoTool@0
            inputs:
              version: '1.22.5'
            displayName: "Use Go 1.22.5"

          - script: |
              cd Golang
              go version
              go mod tidy
              go test ./... -v
              go build -o app
            displayName: "Test & Build Backend"

          - task: ArchiveFiles@2
            displayName: "Zip backend binary"
            inputs:
              rootFolderOrFile: 'Golang/app'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
              replaceExistingArchive: true

          - publish: $(Build.ArtifactStagingDirectory)/backend.zip
            artifact: drop_back
            displayName: "Publish Backend Artifact"


  # ===========================
  # STAGE 2: DEPLOY TO QA (CD)
  # ===========================
  - stage: DeployQA
    displayName: "Deploy to QA Environment"
    dependsOn: CI
    condition: succeeded()
    jobs:

      # ---------- DEPLOY FRONTEND ----------
      - deployment: DeployFrontendQA
        displayName: "Deploy Frontend QA"
        environment: 'QA'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop_front

                - task: AzureWebApp@1
                  displayName: "Deploy Frontend to QA Web App"
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webApp'
                    appName: '$(webAppFrontendQA)'
                    package: '$(Pipeline.Workspace)/drop_front/frontend.zip'

      # ---------- DEPLOY BACKEND ----------
      - deployment: DeployBackendQA
        displayName: "Deploy Backend QA"
        environment: 'QA'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop_back

                - task: AzureWebApp@1
                  displayName: "Deploy Backend to QA Web App"
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    appType: 'webApp'
                    appName: '$(webAppBackendQA)'
                    package: '$(Pipeline.Workspace)/drop_back/backend.zip'
