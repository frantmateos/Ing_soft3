trigger:
  branches:
    include:
      - Task-1

pool:
  name: MiPool

variables:
- name: azureSubscription
  value: 'tp05-connection'
- name: webAppFrontendQA
  value: 'webapp-QA-2025'
- name: webAppBackendQA
  value: 'BACKEND-QA-2025'
- name: REACT_APP_BACKEND_URL_QA
  value: 'https://backend-qa-2025.azurewebsites.net'
- name: webAppFrontendPROD
  value: 'webapp-PRODU-2025'
- name: webAppBackendPROD
  value: 'BACKEND-PRODU-2025'
- name: REACT_APP_BACKEND_URL_PROD
  value: 'https://backend-produ-2025.azurewebsites.net'

stages:
# ===========================
# STAGE 1: BUILD & TEST
# ===========================
- stage: BuildAndTest
  displayName: "Build, Test Frontend & Backend"
  jobs:

  # ---------- FRONTEND QA (simple y robusto) ----------
  - job: BuildAndTestFrontQA
    displayName: "Build & Test Frontend (QA)"
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '16.x'
      displayName: "Set Node.js version (16.x)"

    - task: CmdLine@2
      displayName: "Install, Test & Build Frontend for QA"
      inputs:
        script: |
          cd frontend

          echo "Node/npm:"
          node -v
          npm -v

          # Solo la variable que necesita tu app
          echo "REACT_APP_BACKEND_URL=${REACT_APP_BACKEND_URL_QA}" > .env
          echo "Usando .env:" && cat .env

          echo "Config npm para CI robusto"
          npm config set engine-strict false
          npm config set legacy-peer-deps true
          npm config set audit false
          npm config set fund false

          echo "ğŸ“¦ npm ci (fallback a npm install si falla)"
          if ! npm ci --no-audit --no-fund --legacy-peer-deps --unsafe-perm; then
            echo "npm ci fallÃ³. Fallback a npm install limpioâ€¦"
            rm -rf node_modules package-lock.json
            npm install --no-audit --no-fund --legacy-peer-deps --unsafe-perm
          fi

          echo "ğŸ§ª Tests (fallan si hay errores reales)"
          npm test -- --watchAll=false

          echo "ğŸŒ Build QA sin cortar por warnings (CI=false + sin ESLint en build)"
          CI=false DISABLE_ESLINT_PLUGIN=true npm run build

          echo "ğŸ§© Agrego server de Node para Azure App Service"
          cat > build/server.js <<'EOF'
          const express = require("express");
          const path = require("path");
          const compression = require("compression");
          const app = express();
          const port = process.env.PORT || 8080;
          app.use(compression());
          app.use(express.static(path.join(__dirname)));
          app.get("*", (_, res) => res.sendFile(path.join(__dirname, "index.html")));
          app.listen(port, () => console.log(`âœ… Frontend running on port ${port}`));
          EOF

          cat > build/package.json <<'EOF'
          {
            "name": "frontend-spa",
            "version": "1.0.0",
            "scripts": { "start": "node server.js" },
            "dependencies": {
              "express": "^4.18.2",
              "compression": "^1.7.4"
            }
          }
          EOF

          cd build
          npm install --production --no-audit --no-fund

    - task: ArchiveFiles@2
      displayName: "Zip Frontend QA build"
      inputs:
        rootFolderOrFile: 'frontend/build'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend-qa.zip'
        replaceExistingArchive: true

    - task: ecdc45f6-832d-4ad9-b52b-ee49e94659be@1
      displayName: "Publish Frontend QA Artifact"
      inputs:
        path: $(Build.ArtifactStagingDirectory)/frontend-qa.zip
        artifactName: drop_front_qa

  # ---------- FRONTEND PROD (tu versiÃ³n que funciona) ----------
  - job: BuildFrontPROD
    displayName: "Build Frontend (Production)"
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '16.x'
      displayName: "Set Node.js version (16.x)"

    - task: CmdLine@2
      displayName: "Build Frontend for Production"
      inputs:
        script: |
          set -e
          cd frontend
          echo "ğŸŒ Building React app for Production..."
          echo "REACT_APP_BACKEND_URL=${REACT_APP_BACKEND_URL_PROD}" > .env
          cat .env
          npm install
          npm run build

          echo "ğŸ§© Adding Node server for Azure..."
          cat > build/server.js <<'EOF'
          const express = require("express");
          const path = require("path");
          const compression = require("compression");
          const app = express();
          const port = process.env.PORT || 8080;
          app.use(compression());
          app.use(express.static(path.join(__dirname)));
          app.get("*", (_, res) => res.sendFile(path.join(__dirname, "index.html")));
          app.listen(port, () => console.log(`âœ… Frontend running on port ${port}`));
          EOF

          cat > build/package.json <<'EOF'
          {
            "name": "frontend-spa",
            "version": "1.0.0",
            "scripts": { "start": "node server.js" },
            "dependencies": {
              "express": "^4.18.2",
              "compression": "^1.7.4"
            }
          }
          EOF

          cd build
          npm install --production

    - task: ArchiveFiles@2
      displayName: "Zip Frontend PROD build"
      inputs:
        rootFolderOrFile: 'frontend/build'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/frontend-prod.zip'
        replaceExistingArchive: true

    - task: ecdc45f6-832d-4ad9-b52b-ee49e94659be@1
      displayName: "Publish Frontend PROD Artifact"
      inputs:
        path: $(Build.ArtifactStagingDirectory)/frontend-prod.zip
        artifactName: drop_front_prod

  # ---------- BACKEND (sin cambios) ----------
  - job: BuildAndTestBack
    displayName: "Build & Test Backend (Go)"
    steps:

    - checkout: self
      fetchDepth: 0
    - task: GoTool@0
      inputs:
        version: '1.22.1'
      displayName: "Use Go version"

    - task: SonarCloudPrepare@3
      inputs:
        SonarQube: 'SonarCloud'
        organization: 'frantmateos'
        scannerMode: 'CLI'                     # âœ… modo CLI (no usa dotnet)
        configMode: 'manual'
        cliProjectKey: 'frantmateos_Ing_soft3'
        cliProjectName: 'Ing_soft3'
        cliSources: 'Golang'                   # âœ… carpeta donde estÃ¡ tu cÃ³digo Go
        cliOptions: '-Dsonar.exclusions=**/vendor/**,**/tests/**'

    - task: CmdLine@2
      displayName: "Tidy, Test & Build Backend"
      inputs:
        script: |
          cd Golang
          echo "ğŸ“¦ Tidying Go modules..."
          go mod tidy
          echo "ğŸ§ª Running Go tests..."
          go test ./... -v
          echo "ğŸ”¨ Building Go binary for Linux..."
          GOOS=linux GOARCH=amd64 go build -o ../app
        failOnStderr: true
    
    - script: |
        echo "â˜• Setting Java 17 environment variables..."
        JAVA_PATH=$(/usr/libexec/java_home -v 17)
        echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_PATH"
        echo "##vso[task.setvariable variable=PATH]$JAVA_PATH/bin:$PATH"
        java -version
      displayName: "Configure Java 17 for SonarCloud"


    - task: SonarCloudAnalyze@3
      displayName: "Run SonarCloud Analysis"
      inputs:
        jdkversion: 'JAVA_HOME_17_X64'    

    - task: SonarCloudPublish@3
      displayName: "Publish SonarCloud Results"
      inputs:
          pollingTimeoutSec: '300'
    - task: ArchiveFiles@2
      displayName: "Zip backend binary"
      inputs:
        rootFolderOrFile: 'app'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
        replaceExistingArchive: true
    - task: ecdc45f6-832d-4ad9-b52b-ee49e94659be@1
      displayName: "Publish Backend Artifact"
      inputs:
        path: $(Build.ArtifactStagingDirectory)/backend.zip
        artifactName: drop_back

# ===========================
# STAGE 2: DEPLOY QA
# ===========================
- stage: DeployQA
  displayName: "ğŸš€ Deploy to QA Environment"
  dependsOn:
    - BuildAndTest
  condition: succeeded()
  jobs:
  - deployment: DeployFrontendQA
    displayName: "Deploy Frontend QA"
    environment:
      name: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: 30f35852-3f7e-4c0c-9a88-e127b4f97211@1
            inputs:
              alias: current
              artifact: drop_front_qa
          - task: AzureWebApp@1
            displayName: "Deploy Frontend to QA Web App"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webApp'
              appName: '$(webAppFrontendQA)'
              package: '$(Pipeline.Workspace)/drop_front_qa/frontend-qa.zip'

  - deployment: DeployBackendQA
    displayName: "Deploy Backend QA"
    environment:
      name: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: 30f35852-3f7e-4c0c-9a88-e127b4f97211@1
            inputs:
              alias: current
              artifact: drop_back
          - task: AzureWebApp@1
            displayName: "Deploy Backend to QA Web App"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webApp'
              appName: '$(webAppBackendQA)'
              package: '$(Pipeline.Workspace)/drop_back/backend.zip'
              appSettings: |
                -name WEBSITE_STARTUP_FILE -value ./app

# ===========================
# STAGE 3: DEPLOY PROD
# ===========================
- stage: DeployPROD
  displayName: "ğŸš€ Deploy to Production (Manual Approval)"
  dependsOn:
    - DeployQA
  condition: succeeded()
  jobs:
  - deployment: DeployFrontendPROD
    displayName: "Deploy Frontend PROD"
    environment:
      name: 'PRODU'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: 30f35852-3f7e-4c0c-9a88-e127b4f97211@1
            inputs:
              alias: current
              artifact: drop_front_prod
          - task: AzureWebApp@1
            displayName: "Deploy Frontend to PROD Web App"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webApp'
              appName: '$(webAppFrontendPROD)'
              package: '$(Pipeline.Workspace)/drop_front_prod/frontend-prod.zip'

  - deployment: DeployBackendPROD
    displayName: "Deploy Backend PROD"
    environment:
      name: 'PRODU'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: 30f35852-3f7e-4c0c-9a88-e127b4f97211@1
            inputs:
              alias: current
              artifact: drop_back
          - task: AzureWebApp@1
            displayName: "Deploy Backend to PROD Web App"
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webApp'
              appName: '$(webAppBackendPROD)'
              package: '$(Pipeline.Workspace)/drop_back/backend.zip'
              appSettings: |
                -name WEBSITE_STARTUP_FILE -value ./app
