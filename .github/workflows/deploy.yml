name: CI-CD ACR + ACI

on:
  push:
    branches: ["main", "Task-1"]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ==========================================================
  # 1) BUILD + TEST BACKEND (Go)
  # ==========================================================
  build-backend:
    name: Build & Test Backend
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: "1.22"

    - name: Install gotestsum
      run: go install gotest.tools/gotestsum@latest

    - name: Run Backend Tests (JUnit + coverage + summary)
      run: |
        cd Golang
        go mod tidy

        # Run tests with JSON output
        ~/go/bin/gotestsum --format testname --jsonfile test-output.json --junitfile test-report.xml -- -coverprofile=coverage.out ./...

        # =============================
        # EXTRACT TEST SUMMARY (NEW)
        # =============================
        total=$(jq '.Tests | length' test-output.json)
        passed=$(jq '[.Tests[] | select(.Action=="pass")] | length' test-output.json)
        failed=$(jq '[.Tests[] | select(.Action=="fail")] | length' test-output.json)
        skipped=$(jq '[.Tests[] | select(.Action=="skip")] | length' test-output.json)

        echo "TOTAL_TESTS=$total" >> $GITHUB_ENV
        echo "PASSED_TESTS=$passed" >> $GITHUB_ENV
        echo "FAILED_TESTS=$failed" >> $GITHUB_ENV
        echo "SKIPPED_TESTS=$skipped" >> $GITHUB_ENV

    - name: Upload Backend Test Results
      uses: actions/upload-artifact@v4
      with:
        name: backend-tests
        path: Golang/test-report.xml

    - name: Upload Backend Coverage (raw)
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: Golang/coverage.out

    - name: Generate Human Coverage Summary
      run: |
        cd Golang
        go tool cover -func=coverage.out > coverage.txt

    - name: Upload Backend Coverage (human readable)
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage-human
        path: Golang/coverage.txt

    - name: SonarCloud Scan (Backend)
      uses: SonarSource/sonarcloud-github-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=frantmateos_Ing_soft32
          -Dsonar.organization=${{ secrets.SONAR_ORG }}
          -Dsonar.projectBaseDir=Golang
          -Dsonar.sources=.
          -Dsonar.go.coverage.reportPaths=coverage.out
          -Dsonar.inclusions=**/*.go
          -Dsonar.exclusions=./frontend/**,**/Dockerfile
          -Dsonar.host.url=https://sonarcloud.io

    - name: Build Backend Binary
      run: |
        cd Golang
        GOOS=linux GOARCH=amd64 go build -o ../app

    - name: Upload Backend Build
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: app

    - name: Publish Coverage Summary (Backend)
      run: |
        echo "## Backend Tests Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Total tests: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
        echo "- Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
        echo "- Failed: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
        echo "- Skipped: $SKIPPED_TESTS" >> $GITHUB_STEP_SUMMARY

        echo "## Backend Coverage" >> $GITHUB_STEP_SUMMARY
        cd Golang
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        go tool cover -func=coverage.out | sed -n '1,20p' >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY


  # ==========================================================
  # 2) BUILD + TEST FRONTEND (Jest + JUnit)
  # ==========================================================
  build-frontend:
    name: Build & Test Frontend
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node 16
      uses: actions/setup-node@v3
      with:
        node-version: 16

    - name: Install & Test Frontend
      run: |
        cd frontend
        echo "REACT_APP_BACKEND_URL=${{ secrets.BACKEND_QA_URL }}" > .env

        npm install --legacy-peer-deps
        npm install jest-junit --legacy-peer-deps
        JEST_JUNIT_OUTPUT=./junit.xml npm test -- --watchAll=false --reporters=default --reporters=jest-junit

        # Coverage
        npm test -- --coverage --watchAll=false
        
        # =============================
        # GENERATE LEGIBLE COVERAGE
        # =============================
        # Generate readable coverage summary without external tools
        echo "Statements: $(grep -o 'lines\.[0-9]*\.[0-9]*' coverage/lcov.info | head -1 | cut -d. -f2)%" > coverage-summary.txt
        echo "Branches:   $(grep -o 'branches\.[0-9]*\.[0-9]*' coverage/lcov.info | head -1 | cut -d. -f2)%" >> coverage-summary.txt
        echo "Functions:  $(grep -o 'functions\.[0-9]*\.[0-9]*' coverage/lcov.info | head -1 | cut -d. -f2)%" >> coverage-summary.txt
        echo "Lines:      $(grep -o 'lines\.[0-9]*\.[0-9]*' coverage/lcov.info | head -1 | cut -d. -f2)%" >> coverage-summary.txt


    - name: Upload Frontend Test Results
      uses: actions/upload-artifact@v4
      with:
        name: frontend-tests
        path: frontend/junit.xml

    - name: Publish Frontend Coverage Summary (Legible)
      run: |
        echo "## Frontend Coverage" >> $GITHUB_STEP_SUMMARY
        cd frontend
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat coverage-summary.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY


  # ==========================================================
  # 3) QA BUILD & DEPLOY
  # ==========================================================
  docker-build-push-qa:
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Docker Login
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

    - name: Build Backend QA
      run: docker build -t ${{ secrets.DOCKERHUB_USER }}/backend:latest -f Golang/Dockerfile .

    - name: Build Frontend QA
      run: |
        docker build \
          -t ${{ secrets.DOCKERHUB_USER }}/frontend:latest \
          --build-arg REACT_APP_BACKEND_URL=${{ secrets.BACKEND_QA_URL }} \
          -f frontend/Dockerfile frontend/

    - name: Push QA images
      run: |
        docker push ${{ secrets.DOCKERHUB_USER }}/backend:latest
        docker push ${{ secrets.DOCKERHUB_USER }}/frontend:latest
        
    - name: Install Railway CLI
      run: npm i -g @railway/cli

    - name: Deploy Backend QA to Railway
      run: railway redeploy --service backend-qa --yes
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Deploy Frontend QA to Railway
      run: railway redeploy --service frontend-qa --yes
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}


  # ======================================================
  # 5) E2E CYPRESS QA
  # ======================================================
  e2e-qa:
    name: E2E Cypress Tests (QA)
    needs: docker-build-push-qa
    runs-on: ubuntu-latest
  
    steps:
    - uses: actions/checkout@v3

    - name: Wait for QA to be ready
      run: sleep 50
  
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 16
  
    - name: Install Cypress
      run: |
        cd frontend
        npm install --legacy-peer-deps
        npx cypress verify
  
    - name: Run Cypress Tests against QA
      run: |
        cd frontend
        mkdir -p cypress/results
        npx cypress run \
          --spec "cypress/e2e/test-*.cy.js" \
          --reporter junit \
          --reporter-options "mochaFile=cypress/results/junit-[hash].xml,toConsole=true" \
          --config baseUrl=https://frontend-qa-production.up.railway.app


  # ======================================================
  # 6) BUILD & PUSH PROD
  # ======================================================
  docker-build-push-prod:
    needs: e2e-qa
    runs-on: ubuntu-latest
    environment:
      name: PROD
    steps:
    - uses: actions/checkout@v3

    - name: Install Railway CLI
      run: npm i -g @railway/cli
   
    - name: Deploy Backend PROD to Railway
      run: railway redeploy --service backend-prod --yes
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Deploy Frontend PROD to Railway
      run: railway redeploy --service frontend-prod --yes
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
