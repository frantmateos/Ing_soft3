name: CI-CD ACR + ACI

on:
  push:
    branches: ["main", "Task-1"]

    
permissions:
  contents: read
  checks: write
  pull-requests: write


env:
  ACR_NAME: ingsoft3ucc
  ACR_LOGIN_SERVER: ingsoft3ucc.azurecr.io
  RESOURCE_GROUP: TP5-2025
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

jobs:
  # ==========================================================
  # 1) BUILD + TEST BACKEND (Go)
  # ==========================================================
  build-backend:
    name: Build & Test Backend
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: "1.22"

    - name: Run Backend Tests (JUnit + coverage)
      run: |
        cd Golang
        go mod tidy
        go test ./... -v -coverprofile=coverage.out -json > test-report.json

    - name: Upload Backend Test Results
      uses: actions/upload-artifact@v4
      with:
        name: backend-tests
        path: Golang/test-report.json

    - name: Upload Backend Coverage
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: Golang/coverage.out
        
    - name: SonarCloud Scan (Backend)
      uses: SonarSource/sonarcloud-github-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=frantmateos_Ing_soft32
          -Dsonar.organization=${{ secrets.SONAR_ORG }}
          -Dsonar.projectBaseDir=Golang
          -Dsonar.sources=./
          -Dsonar.tests=.
          -Dsonar.go.coverage.reportPaths=coverage.out
          -Dsonar.inclusions=**/*.go
          -Dsonar.exclusions=./frontend/**,**/Dockerfile
          -Dsonar.host.url=https://sonarcloud.io



    - name: Build Backend Binary
      run: |
        cd Golang
        GOOS=linux GOARCH=amd64 go build -o ../app

    - name: Upload Backend Build
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: app
        

    - name: Publish Coverage Summary (Backend)
      run: |
        echo "## Backend Coverage" >> $GITHUB_STEP_SUMMARY
        cd Golang
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        head -n 20 coverage.out >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY



  # ==========================================================
  # 2) BUILD + TEST FRONTEND (Jest + JUnit)
  # ==========================================================
  build-frontend:
    name: Build & Test Frontend
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node 16
      uses: actions/setup-node@v3
      with:
        node-version: 16

    - name: Install & Test Frontend
      run: |
        cd frontend
        echo "REACT_APP_BACKEND_URL=http://backend-instance-qa.brazilsouth.azurecontainer.io:8081" > .env

        npm install --legacy-peer-deps

        # Run tests with JUnit report
        npm install jest-junit --legacy-peer-deps
        JEST_JUNIT_OUTPUT=./junit.xml npm test -- --watchAll=false --reporters=default --reporters=jest-junit
        npm test -- --coverage --watchAll=false

    - name: Upload Frontend Test Results
      uses: actions/upload-artifact@v4
      with:
        name: frontend-tests
        path: frontend/junit.xml

    - name: SonarCloud Scan (Frontend)
      uses: SonarSource/sonarcloud-github-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=frantmateos_Ing_soft32
          -Dsonar.organization=${{ secrets.SONAR_ORG }}
          -Dsonar.projectBaseDir=frontend
          -Dsonar.sources=src
          -Dsonar.tests=src
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
          -Dsonar.exclusions=**/*.test.*,node_modules/**,build/**,../Golang/**,**/Dockerfile
          -Dsonar.host.url=https://sonarcloud.io



    - name: Build Frontend
      run: |
        cd frontend
        CI=false npm run build

    - name: Upload Frontend Build
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/build

    - name: Publish Frontend Test Report
      uses: mikepenz/action-junit-report@v4
      if: always()
      with:
        report_paths: 'frontend/junit.xml'

    - name: Publish Coverage Summary (Frontend)
      run: |
        echo "## Frontend Coverage" >> $GITHUB_STEP_SUMMARY
        cd frontend
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        grep -R "" coverage/lcov.info | head -n 20 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY




  # ==========================================================
  # 3) BUILD & PUSH DOCKER IMAGES
  # ==========================================================
  docker-build-push:
    name: Build & Push Docker
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: az acr login --name $ACR_NAME

    - name: Build Backend Image
      run: |
        docker build \
          -t $ACR_LOGIN_SERVER/$BACKEND_IMAGE:latest \
          -f Golang/Dockerfile .

    - name: Build Frontend Image
      run: |
        docker build \
          -t $ACR_LOGIN_SERVER/$FRONTEND_IMAGE:latest \
          -f frontend/Dockerfile \
          --build-arg REACT_APP_BACKEND_URL="http://backend-instance-qa.brazilsouth.azurecontainer.io:8081" \
          frontend/

    - name: Push Docker Images
      run: |
        docker push $ACR_LOGIN_SERVER/$BACKEND_IMAGE:latest
        docker push $ACR_LOGIN_SERVER/$FRONTEND_IMAGE:latest

  # ==========================================================
  # 4) DEPLOY QA (BACK + FRONT)
  # ==========================================================
  deploy-qa:
    name: Deploy QA
    needs: docker-build-push
    runs-on: ubuntu-latest

    steps:
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Backend QA
      run: |
        az container delete -g $RESOURCE_GROUP -n backend-instance-qa --yes || true
        az container create \
          -g $RESOURCE_GROUP \
          -n backend-instance-qa \
          --image $ACR_LOGIN_SERVER/$BACKEND_IMAGE:latest \
          --registry-login-server $ACR_LOGIN_SERVER \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label backend-instance-qa \
          --os-type Linux \
          --ports 8081 \
          --cpu 1 \
          --memory 1.5 \
          --environment-variables \
            PORT=8081 \
            ENVIRONMENT=QA \
            DB_HOST=mysql-server-2025.mysql.database.azure.com \
            DB_NAME=tp05_qa \
            DB_USER=adminqa \
            DB_PASS=Tomas1927

    - name: Deploy Frontend QA
      run: |
        az container delete -g $RESOURCE_GROUP -n frontend-instance-qa --yes || true
        az container create \
          -g $RESOURCE_GROUP \
          -n frontend-instance-qa \
          --image $ACR_LOGIN_SERVER/$FRONTEND_IMAGE:latest \
          --registry-login-server $ACR_LOGIN_SERVER \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label frontend-instance-qa \
          --os-type Linux \
          --ports 80 \
          --cpu 1 \
          --memory 1.0

  # ==========================================================
  # 5) E2E CYPRESS QA
  # ==========================================================
  e2e-qa:
    name: E2E Cypress Tests (QA)
    needs: deploy-qa
    runs-on: ubuntu-latest
  
    steps:
    - uses: actions/checkout@v3
  
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 16
  
    - name: Install Cypress
      run: |
        cd frontend
        npm install --legacy-peer-deps
        npx cypress verify
  
    - name: Run Cypress Tests against QA
      run: |
        cd frontend
        mkdir -p cypress/results
        npx cypress run \
          --spec "cypress/e2e/test-*.cy.js" \
          --reporter junit \
          --reporter-options "mochaFile=cypress/results/junit-[hash].xml,toConsole=true" \
          --config baseUrl=http://frontend-instance-qa.brazilsouth.azurecontainer.io


  # ==========================================================
  # 6) DEPLOY PRODUCTION (solo si TODO sali√≥ bien)
  # ==========================================================
  deploy-prod:
    name: Deploy PROD
    needs: [e2e-qa]
    runs-on: ubuntu-latest

    steps:
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Backend PROD
      run: |
        az container delete -g $RESOURCE_GROUP -n backend-instance-prod --yes || true
        az container create \
          -g $RESOURCE_GROUP \
          -n backend-instance-prod \
          --image $ACR_LOGIN_SERVER/$BACKEND_IMAGE:latest \
          --registry-login-server $ACR_LOGIN_SERVER \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label backend-instance-prod \
          --os-type Linux \
          --ports 8081 \
          --cpu 1 \
          --memory 1.5 \
          --environment-variables \
            PORT=8081 \
            ENVIRONMENT=PRODU \
            DB_HOST=mysql-server-2025.mysql.database.azure.com \
            DB_NAME=tp05_produ \
            DB_USER=adminqa \
            DB_PASS=Tomas1927


    - name: Deploy Frontend PROD
      run: |
        az container delete -g $RESOURCE_GROUP -n frontend-instance-prod --yes || true
        az container create \
          -g $RESOURCE_GROUP \
          -n frontend-instance-prod \
          --image $ACR_LOGIN_SERVER/$FRONTEND_IMAGE:latest \
          --registry-login-server $ACR_LOGIN_SERVER \
          --registry-username ${{ secrets.ACR_USERNAME }} \
          --registry-password ${{ secrets.ACR_PASSWORD }} \
          --dns-name-label frontend-instance-prod \
          --os-type Linux \
          --ip-address Public \
          --ports 80 \
          --cpu 1 \
          --memory 1.0 \
          --environment-variables \
            REACT_APP_BACKEND_URL="http://backend-instance-prod.brazilsouth.azurecontainer.io:8081"
