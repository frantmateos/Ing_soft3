trigger:
  branches:
    include:
      - Task-1
      - main
      - tomi

pool:
  name: MiPool

variables:
  # ====== Apps / Infra ======
  - name: REACT_APP_BACKEND_URL_QA
    value: 'https://backend-qa-2025.azurewebsites.net'
  # ====== SonarCloud ======
  - name: sonarServiceConnection
    value: 'SonarCloud'
  - name: sonarOrg
    value: 'frantmateos'

stages:
# ======================================================
# =                BUILD & TEST (CI)                  =
# ======================================================
- stage: BuildAndTest
  displayName: "Build, Test Frontend & Backend (solo QA + Sonar)"
  jobs:

  # ---------- FRONTEND QA ----------
  - job: BuildAndTestFrontQA
    displayName: "Build & Test Frontend (QA)"
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '16.x'
        displayName: "Set Node.js 16.x"

      - task: CmdLine@2
        displayName: "Install, Test (con Cobertura) & Build Frontend"
        inputs:
          script: |
            set -e
            cd frontend
            echo "REACT_APP_BACKEND_URL=${REACT_APP_BACKEND_URL_QA}" > .env
            npm config set engine-strict false
            npm config set legacy-peer-deps true
            npm config set audit false
            npm config set fund false
            echo "ðŸ“¦ npm ci"
            if ! npm ci --no-audit --no-fund --legacy-peer-deps --unsafe-perm; then
              rm -rf node_modules package-lock.json
              npm install --no-audit --no-fund --legacy-peer-deps --unsafe-perm
            fi
            echo "ðŸ§ª Tests (lcov + cobertura)"
            npm test -- --coverage --watchAll=false --coverageReporters=lcov --coverageReporters=cobertura
            echo "ðŸŒ Build QA"
            CI=false DISABLE_ESLINT_PLUGIN=true npm run build

      - task: PublishCodeCoverageResults@2
        displayName: "Publish Frontend Coverage (Cobertura)"
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'frontend/coverage/cobertura-coverage.xml'
          reportDirectory: 'frontend/coverage/lcov-report'
          failIfCoverageEmpty: false

      - task: PublishPipelineArtifact@1
        displayName: 'Attach Frontend Coverage (lcov folder)'
        inputs:
          targetPath: 'frontend/coverage'
          artifactName: 'frontend_coverage_lcov'

  # ---------- BACKEND (Go) + SONARCLOUD ----------
  - job: BuildAndTestBack
    displayName: "Build & Test Backend (Go) + SonarCloud"
    dependsOn: BuildAndTestFrontQA
    steps:
      - checkout: self
        fetchDepth: 0
        persistCredentials: true

      - task: GoTool@0
        inputs:
          version: '1.22.1'
        displayName: "Use Go 1.22.1"

      - task: SonarCloudPrepare@2
        displayName: "SonarCloud Prepare (Backend)"
        inputs:
          SonarCloud: '$(sonarServiceConnection)'
          organization: '$(sonarOrg)'
          scannerMode: 'CLI'
          configMode: 'manual'
          cliProjectKey: 'Ing_soft3_backend'
          cliProjectName: 'Backend (Go)'
          extraProperties: |
            sonar.host.url=https://sonarcloud.io
            sonar.organization=$(sonarOrg)
            sonar.projectKey=Ing_soft3_backend
            sonar.projectName=Backend (Go)
            sonar.projectBaseDir=$(Build.SourcesDirectory)/Golang
            sonar.sources=.
            sonar.exclusions=**/vendor/**,**/tests/**
            sonar.go.coverage.reportPaths=coverage.out
            sonar.verbose=true
            sonar.scm.provider=git
            sonar.scanner.dumpToFile=$(Build.SourcesDirectory)/scanner-props-back.txt
            # No enviar sonar.branch.name en Free/primer anÃ¡lisis de la main

      - task: CmdLine@2
        displayName: "go tidy, tests (coverage) & build"
        inputs:
          script: |
            set -e
            cd Golang
            go mod tidy
            go test ./... -coverprofile=coverage.out -covermode=atomic
            go tool cover -html=coverage.out -o coverage.html
            go tool cover -func=coverage.out > coverage.txt
            GOOS=linux GOARCH=amd64 go build -o ../app

      - script: |
          echo "=== scanner-props-back.txt ==="
          cat "$(Build.SourcesDirectory)/scanner-props-back.txt" || true
        displayName: "Print Sonar scanner properties"

      - task: SonarCloudAnalyze@2
        displayName: "Run SonarCloud Analysis (Backend)"

      - script: |
          echo "=== report-task.txt ==="
          find "$(Build.SourcesDirectory)" -name report-task.txt -maxdepth 4 -print -exec cat {} \; || true
        displayName: "Print Sonar report-task (if any)"
        condition: always()

      - task: SonarCloudPublish@2
        displayName: "Publish SonarCloud Results (Backend)"
        inputs:
          pollingTimeoutSec: '300'
        condition: succeeded()
